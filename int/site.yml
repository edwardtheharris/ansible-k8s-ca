---
- name: Create Intermediate CAs
  hosts: ca
  become: true
  tasks:
    - name: Clean
      ansible.builtin.file:
        state: absent
        dest: "{{ item[1] }}"
      loop: >-
        {{ q('ansible.builtin.subelements', intermediates, 'paths') }}
      tags:
        - clean
    - name: Create Intermediate CA key
      community.crypto.openssl_privatekey:
        path: "{{ item.paths.5 }}"
      loop: >-
        {{ intermediates }}
      tags:
        - int
        - key
    - name: Create certificate signing request (CSR) for new certificate
      community.crypto.openssl_csr:
        backup: true
        basic_constraints:
          - 'CA:TRUE'
        # create_subject_key_identifier: true
        email_address: "{{ dn.email }}"
        path: "{{ item.paths.4 }}"
        privatekey_path: "{{ item.paths.5 }}"
        subject_alt_name: "{{ item.subj_alt }}"
      loop: >
        {{ intermediates }}
      tags:
        - int
        - csr
    - name: Sign certificate with our CA
      community.crypto.x509_certificate:
        csr_path: "{{ item.paths.4 }}"
        ownca_not_after: '+36500d'
        ownca_not_before: "-1d"
        ownca_path: "{{ paths.0 }}"
        ownca_privatekey_passphrase: "{{ passphrase }}"
        ownca_privatekey_path: "{{ paths.3 }}"
        path: "{{ item.paths.2 }}"
        provider: ownca
      loop: "{{ intermediates }}"
      tags:
        - int
        - sign
    - name: Get dc01.int.crt info
      community.crypto.x509_certificate:
        csr_path: /etc/ssl/csr/dc01.int.csr
        ownca_path: "{{ paths.0 }}"
        ownca_privatekey_passphrase: "{{ passphrase }}"
        ownca_privatekey_path: "{{ paths.3 }}"
        provider: ownca
        path: /etc/ssl/certs/dc01.int.crt
        return_content: true
      register: int
      tags:
        - int
    - name: Dump information
      ansible.builtin.debug:
        var: int.certificate
      tags:
        - int
    - name: Complete chain
      community.crypto.certificate_complete_chain:
        input_chain: >-
          {{ int.certificate }}
        intermediate_certificates:
          - /etc/ssl/certs/dc02.int.crt
        root_certificates:
          - "{{ paths.0 }}"
      register: chain
      delegate_to: ca
      tags:
        - int
        - chain
    - name: Copy chain cert
      ansible.builtin.copy:
        dest: /etc/ssl/certs/ca.chain.crt
        content: "{{ ''.join(chain.complete_chain) }}"
        owner: root
        group: root
        mode: 'u+rw,g+rw'
      delegate_to: ca
      tags:
        - int
        - chain
- name: Copy Intermediate CA to remotes
  hosts: bm
  remote_user: duchess
  become: true
  tasks:
    - name: Copy Intermediate CAs to remotes
      ansible.builtin.copy:
        owner: root
        group: root
        mode: 'u+rw,g+rw'
        remote_src: "{{ item }}"
        dest: "{{ item }}"
      loop:
        - /etc/ssl/certs/dc01.int.crt
        - /etc/ssl/certs/dc02.int.crt
        - /etc/ssl/certs/ca.chain.crt
      delegate_to: ca
      tags:
        - int
