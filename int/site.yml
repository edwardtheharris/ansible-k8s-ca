---
- name: Create Intermediate CAs
  hosts: dc01,dc02
  become: true
  tasks:
    - name: Create private key for new certificate on IA
      community.crypto.openssl_privatekey:
        path: /etc/ssl/private/int.ca.key
      delegate_to: >-
        {{ ansible_host }}
    - name: Create certificate signing request (CSR) for new certificate
      community.crypto.openssl_csr_pipe:
        basic_constraints:
          - 'CA:TRUE'
          - 'pathlen:0'
        basic_constraints_critical: true
        key_usage:
          - keyCertSign
          - cRLSign
          - digitalSignature
        privatekey_path: /etc/ssl/private/int.ca.key
        subject_alt_name: >-
          {{ subj_alt }}
      delegate_to: >-
        {{ ansible_host }}
      register: csr
    - name: Check whether certificate exists
      stat:
        path: /etc/ssl/certs/int.ca.crt
      delegate_to: >-
        {{ ansible_host }}
      register: certificate_exists
    - name: Read existing certificate if exists
      ansible.builtin.slurp:
        src: /etc/ssl/certs/int.ca.crt
      when: certificate_exists.stat.exists
      delegate_to: >-
        {{ ansible_host }}
      register: certificate
    - name: Sign certificate with our CA
      community.crypto.x509_certificate_pipe:
        content: >-
          {{ (certificate.content | b64decode) if certificate_exists.stat.exists else omit }}
        csr_content: >-
          {{ csr.csr }}
        provider: ownca
        ownca_path: >-
          {{ ca.paths.ca }}
        ownca_privatekey_path: >-
          {{ ca.paths.key }}
        ownca_privatekey_passphrase: >-
          {{ secret_ca_passphrase }}
        ownca_not_after: +36500d  # valid for one year
        ownca_not_before: "-1d"  # valid since yesterday
      delegate_to: >-
        {{ dn.cn }}
      register: certificate
    - name: Write certificate file on IA
      ansible.builtin.copy:
        dest: /etc/ssl/certs/int.ca.crt
        content: >-
          {{ certificate.certificate }}
      delegate_to: >-
        {{ ansible_host }}
    - name: Write certificate file on CA
      ansible.builtin.copy:
        dest: /etc/ssl/certs/int.ca.crt
        content: >-
          {{ certificate.certificate }}
      delegate_to: >-
        {{ dn.cn }}
- name: Create chain for secondary
  hosts: dc02
  become: true
  tasks:
    - name: Read existing certificate if exists
      ansible.builtin.slurp:
        src: /etc/ssl/certs/int.ca.crt
      when: certificate_exists.stat.exists
      delegate_to: >-
        {{ dn.cn }}
      register: certificate
    - name: Complete the cert chain
      community.crypto.certificate_complete_chain:
        input_chain: >-
          {{ (certificate.content | b64decode) if certificate_exists.stat.exists else omit }}
        intermediate_certificates:
          - /etc/ssl/certs
        root_certificates:
          - /etc/ssl/certs/ca.crt
      delegate_to: >-
        {{ dn.cn }}
      register: chain_cert
    - name: Write complete chain to disk
      ansible.builtin.copy:
        dest: /etc/ssl/certs/ca.bundle.crt
        content: >-
          {{ ''.join(chain_cert.complete_chain) }}
    - name: Write root chain (intermediates and root) to disk
      ansible.builtin.copy:
        dest: /etc/ssl/certs/ca.chain.crt
        content: >-
          {{ ''.join(chain_cert.chain) }}
